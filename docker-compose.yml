version: "3.9"

services:
  mongo:
    image: mongo:7.0
    container_name: mongo
    restart: unless-stopped
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: mongo
      MONGO_INITDB_ROOT_PASSWORD: Mdiel115@
    volumes:
      - ./data/mongo:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--username", "mongo", "--password", "Mdiel115@", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - ollama-net

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11534:11434"
    volumes:
      - ./ollama:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - ollama-net

  ollama-chat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ollama-chat
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      ollama:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      SPRING_DATA_MONGODB_URI: mongodb://mongo:Mdiel115%40@mongo:27017/ollama_chat_db?authSource=admin
      OLLAMA_BASE_URL: http://ollama:11434
      JAVA_TOOL_OPTIONS: "-Djava.net.preferIPv4Stack=true -Xms512m -Xmx1g"
      http_proxy: http://host.docker.internal:3128
      https_proxy: http://host.docker.internal:3128
      no_proxy: localhost,127.0.0.1,ollama,mongo
    networks:
      - ollama-net

networks:
  ollama-net:
    driver: bridge
